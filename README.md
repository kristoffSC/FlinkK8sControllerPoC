# FlinkK8sControllerPoC


FlinkSessionJob data printed using code snipped:
```java
    private void printFlinSessionJob(final FlinkSessionJob item) {
        System.out.println("Flink Session Job: " + item);
        System.out.println("Cluster: " + item.getSpec().getDeploymentName());
        System.out.println("Job name: " + item.getMetadata().getName());
        System.out.println("Job state: " + item.getStatus().getJobStatus().getState());
        System.out.println("Job upgrade mode: " + item.getSpec().getJob().getUpgradeMode());
        System.out.println("Job Labels: " + item.getMetadata().getLabels());
        System.out.println("SavePoint Info: " + item.getStatus().getJobStatus().getSavepointInfo());
        System.out.println("----");
    }
```

FlinkSessionJob data after updating status to SUSPENDED:
```
Flink Session Job: CustomResource{kind='FlinkSessionJob', apiVersion='flink.apache.org/v1beta1', metadata=ObjectMeta(annotations={}, creationTimestamp=2023-09-18T21:39:32Z, deletionGracePeriodSeconds=null, deletionTimestamp=null, finalizers=[flinksessionjobs.flink.apache.org/finalizer], generateName=null, generation=2, labels={target.session=basic-session-deployment-only-example}, managedFields=[ManagedFieldsEntry(apiVersion=flink.apache.org/v1beta1, fieldsType=FieldsV1, fieldsV1=FieldsV1(additionalProperties={f:metadata={f:finalizers={.={}, v:"flinksessionjobs.flink.apache.org/finalizer"={}}}, f:spec={.={}, f:deploymentName={}, f:job={.={}, f:args={}, f:jarURI={}, f:parallelism={}, f:state={}, f:upgradeMode={}}}}), manager=fabric8-kubernetes-client, operation=Update, subresource=null, time=2023-09-18T21:46:02Z, additionalProperties={}), ManagedFieldsEntry(apiVersion=flink.apache.org/v1beta1, fieldsType=FieldsV1, fieldsV1=FieldsV1(additionalProperties={f:status={.={}, f:jobStatus={.={}, f:jobId={}, f:jobName={}, f:savepointInfo={.={}, f:lastPeriodicSavepointTimestamp={}, f:lastSavepoint={.={}, f:formatType={}, f:location={}, f:timeStamp={}, f:triggerType={}}, f:savepointHistory={}}, f:startTime={}, f:state={}, f:updateTime={}}, f:lifecycleState={}, f:reconciliationStatus={.={}, f:lastReconciledSpec={}, f:lastStableSpec={}, f:reconciliationTimestamp={}, f:state={}}}}), manager=fabric8-kubernetes-client, operation=Update, subresource=status, time=2023-09-18T21:46:09Z, additionalProperties={})], name=basic-session-job-only-example, namespace=default, ownerReferences=[], resourceVersion=560540, selfLink=null, uid=f3ee1b4e-3d82-4588-9040-3ac1c68aac3f, additionalProperties={}), spec=FlinkSessionJobSpec(super=AbstractFlinkSpec(job=JobSpec(jarURI=https://github.com/kristoffSC/FlinkSimpleStreamingJob/raw/jarTests/FlinkSimpleStreamingJob-1.0-SNAPSHOT.jar, parallelism=1, entryClass=null, args=[--restart, yes], state=SUSPENDED, savepointTriggerNonce=null, initialSavepointPath=null, upgradeMode=SAVEPOINT, allowNonRestoredState=null), restartNonce=null, flinkConfiguration=null), deploymentName=basic-session-deployment-only-example), status=FlinkSessionJobStatus(super=CommonStatus(jobStatus=JobStatus(jobName=FLink Toy Streaming job., jobId=f3ee1b4e3d8245880000000000000001, state=FINISHED, startTime=1695073178841, updateTime=1695073356376, savepointInfo=SavepointInfo(lastSavepoint=Savepoint(timeStamp=1695073569337, location=file:/opt/flink/jobs/savepoint-f3ee1b-1d4c88582b8c, triggerType=UPGRADE, formatType=UNKNOWN, triggerNonce=null), triggerId=null, triggerTimestamp=null, triggerType=null, formatType=null, savepointHistory=[Savepoint(timeStamp=1695073569337, location=file:/opt/flink/jobs/savepoint-f3ee1b-1d4c88582b8c, triggerType=UPGRADE, formatType=UNKNOWN, triggerNonce=null)], lastPeriodicSavepointTimestamp=0)), error=null, lifecycleState=SUSPENDED, immediateReconciliationNeeded=false), reconciliationStatus=FlinkSessionJobReconciliationStatus(super=ReconciliationStatus(reconciliationTimestamp=1695073569337, lastReconciledSpec={"spec":{"job":{"jarURI":"https://github.com/kristoffSC/FlinkSimpleStreamingJob/raw/jarTests/FlinkSimpleStreamingJob-1.0-SNAPSHOT.jar","parallelism":1,"entryClass":null,"args":["--restart","yes"],"state":"suspended","savepointTriggerNonce":null,"initialSavepointPath":null,"upgradeMode":"savepoint","allowNonRestoredState":null},"restartNonce":null,"flinkConfiguration":null,"deploymentName":"basic-session-deployment-only-example"},"resource_metadata":{"apiVersion":"flink.apache.org/v1beta1","metadata":{"generation":2},"firstDeployment":true}}, lastStableSpec={"spec":{"job":{"jarURI":"https://github.com/kristoffSC/FlinkSimpleStreamingJob/raw/jarTests/FlinkSimpleStreamingJob-1.0-SNAPSHOT.jar","parallelism":1,"entryClass":null,"args":["--restart","yes"],"state":"suspended","savepointTriggerNonce":null,"initialSavepointPath":null,"upgradeMode":"savepoint","allowNonRestoredState":null},"restartNonce":null,"flinkConfiguration":null,"deploymentName":"basic-session-deployment-only-example"},"resource_metadata":{"apiVersion":"flink.apache.org/v1beta1","metadata":{"generation":2},"firstDeployment":true}}, state=DEPLOYED)))}
Cluster: basic-session-deployment-only-example
Job name: basic-session-job-only-example
Job state: FINISHED
Job upgrade mode: SAVEPOINT
Job Labels: {target.session=basic-session-deployment-only-example}
SavePoint Info: SavepointInfo(lastSavepoint=Savepoint(timeStamp=1695073569337, location=file:/opt/flink/jobs/savepoint-f3ee1b-1d4c88582b8c, triggerType=UPGRADE, formatType=UNKNOWN, triggerNonce=null), triggerId=null, triggerTimestamp=null, triggerType=null, formatType=null, savepointHistory=[Savepoint(timeStamp=1695073569337, location=file:/opt/flink/jobs/savepoint-f3ee1b-1d4c88582b8c, triggerType=UPGRADE, formatType=UNKNOWN, triggerNonce=null)], lastPeriodicSavepointTimestamp=0)
```


FlinkSessionJob data after resuming SUSPENDED job:
```
Flink Session Job: CustomResource{kind='FlinkSessionJob', apiVersion='flink.apache.org/v1beta1', metadata=ObjectMeta(annotations={}, creationTimestamp=2023-09-18T21:39:32Z, deletionGracePeriodSeconds=null, deletionTimestamp=null, finalizers=[flinksessionjobs.flink.apache.org/finalizer], generateName=null, generation=3, labels={target.session=basic-session-deployment-only-example}, managedFields=[ManagedFieldsEntry(apiVersion=flink.apache.org/v1beta1, fieldsType=FieldsV1, fieldsV1=FieldsV1(additionalProperties={f:metadata={f:finalizers={.={}, v:"flinksessionjobs.flink.apache.org/finalizer"={}}}, f:spec={.={}, f:deploymentName={}, f:job={.={}, f:args={}, f:jarURI={}, f:parallelism={}, f:state={}, f:upgradeMode={}}}}), manager=fabric8-kubernetes-client, operation=Update, subresource=null, time=2023-09-18T21:57:13Z, additionalProperties={}), ManagedFieldsEntry(apiVersion=flink.apache.org/v1beta1, fieldsType=FieldsV1, fieldsV1=FieldsV1(additionalProperties={f:status={.={}, f:jobStatus={.={}, f:jobId={}, f:jobName={}, f:savepointInfo={.={}, f:lastPeriodicSavepointTimestamp={}, f:lastSavepoint={.={}, f:formatType={}, f:location={}, f:timeStamp={}, f:triggerType={}}, f:savepointHistory={}}, f:startTime={}, f:state={}, f:updateTime={}}, f:lifecycleState={}, f:reconciliationStatus={.={}, f:lastReconciledSpec={}, f:lastStableSpec={}, f:reconciliationTimestamp={}, f:state={}}}}), manager=fabric8-kubernetes-client, operation=Update, subresource=status, time=2023-09-18T21:57:33Z, additionalProperties={})], name=basic-session-job-only-example, namespace=default, ownerReferences=[], resourceVersion=561659, selfLink=null, uid=f3ee1b4e-3d82-4588-9040-3ac1c68aac3f, additionalProperties={}), spec=FlinkSessionJobSpec(super=AbstractFlinkSpec(job=JobSpec(jarURI=https://github.com/kristoffSC/FlinkSimpleStreamingJob/raw/jarTests/FlinkSimpleStreamingJob-1.0-SNAPSHOT.jar, parallelism=1, entryClass=null, args=[--restart, yes], state=RUNNING, savepointTriggerNonce=null, initialSavepointPath=null, upgradeMode=SAVEPOINT, allowNonRestoredState=null), restartNonce=null, flinkConfiguration=null), deploymentName=basic-session-deployment-only-example), status=FlinkSessionJobStatus(super=CommonStatus(jobStatus=JobStatus(jobName=FLink Toy Streaming job., jobId=f3ee1b4e3d8245880000000000000003, state=CREATED, startTime=1695074236928, updateTime=1695074253870, savepointInfo=SavepointInfo(lastSavepoint=Savepoint(timeStamp=1695073569337, location=file:/opt/flink/jobs/savepoint-f3ee1b-1d4c88582b8c, triggerType=UPGRADE, formatType=UNKNOWN, triggerNonce=null), triggerId=null, triggerTimestamp=null, triggerType=null, formatType=null, savepointHistory=[Savepoint(timeStamp=1695073569337, location=file:/opt/flink/jobs/savepoint-f3ee1b-1d4c88582b8c, triggerType=UPGRADE, formatType=UNKNOWN, triggerNonce=null)], lastPeriodicSavepointTimestamp=0)), error=null, lifecycleState=DEPLOYED, immediateReconciliationNeeded=false), reconciliationStatus=FlinkSessionJobReconciliationStatus(super=ReconciliationStatus(reconciliationTimestamp=1695074238730, lastReconciledSpec={"spec":{"job":{"jarURI":"https://github.com/kristoffSC/FlinkSimpleStreamingJob/raw/jarTests/FlinkSimpleStreamingJob-1.0-SNAPSHOT.jar","parallelism":1,"entryClass":null,"args":["--restart","yes"],"state":"running","savepointTriggerNonce":null,"initialSavepointPath":null,"upgradeMode":"savepoint","allowNonRestoredState":null},"restartNonce":null,"flinkConfiguration":null,"deploymentName":"basic-session-deployment-only-example"},"resource_metadata":{"apiVersion":"flink.apache.org/v1beta1","metadata":{"generation":3},"firstDeployment":false}}, lastStableSpec={"spec":{"job":{"jarURI":"https://github.com/kristoffSC/FlinkSimpleStreamingJob/raw/jarTests/FlinkSimpleStreamingJob-1.0-SNAPSHOT.jar","parallelism":1,"entryClass":null,"args":["--restart","yes"],"state":"suspended","savepointTriggerNonce":null,"initialSavepointPath":null,"upgradeMode":"savepoint","allowNonRestoredState":null},"restartNonce":null,"flinkConfiguration":null,"deploymentName":"basic-session-deployment-only-example"},"resource_metadata":{"apiVersion":"flink.apache.org/v1beta1","metadata":{"generation":2},"firstDeployment":true}}, state=DEPLOYED)))}
Cluster: basic-session-deployment-only-example
Job name: basic-session-job-only-example
Job state: CREATED
Job upgrade mode: SAVEPOINT
Job Labels: {target.session=basic-session-deployment-only-example}
SavePoint Info: SavepointInfo(lastSavepoint=Savepoint(timeStamp=1695073569337, location=file:/opt/flink/jobs/savepoint-f3ee1b-1d4c88582b8c, triggerType=UPGRADE, formatType=UNKNOWN, triggerNonce=null), triggerId=null, triggerTimestamp=null, triggerType=null, formatType=null, savepointHistory=[Savepoint(timeStamp=1695073569337, location=file:/opt/flink/jobs/savepoint-f3ee1b-1d4c88582b8c, triggerType=UPGRADE, formatType=UNKNOWN, triggerNonce=null)], lastPeriodicSavepointTimestamp=0)
```
to:
```
2023-09-18 23:59:51,187 i.f.k.c.d.i.VersionUsageUtils  [WARN ] [.] The client is using resource type 'flinksessionjobs' with unstable version 'v1beta1'
Flink Session Job: CustomResource{kind='FlinkSessionJob', apiVersion='flink.apache.org/v1beta1', metadata=ObjectMeta(annotations={}, creationTimestamp=2023-09-18T21:39:32Z, deletionGracePeriodSeconds=null, deletionTimestamp=null, finalizers=[flinksessionjobs.flink.apache.org/finalizer], generateName=null, generation=3, labels={target.session=basic-session-deployment-only-example}, managedFields=[ManagedFieldsEntry(apiVersion=flink.apache.org/v1beta1, fieldsType=FieldsV1, fieldsV1=FieldsV1(additionalProperties={f:metadata={f:finalizers={.={}, v:"flinksessionjobs.flink.apache.org/finalizer"={}}}, f:spec={.={}, f:deploymentName={}, f:job={.={}, f:args={}, f:jarURI={}, f:parallelism={}, f:state={}, f:upgradeMode={}}}}), manager=fabric8-kubernetes-client, operation=Update, subresource=null, time=2023-09-18T21:57:13Z, additionalProperties={}), ManagedFieldsEntry(apiVersion=flink.apache.org/v1beta1, fieldsType=FieldsV1, fieldsV1=FieldsV1(additionalProperties={f:status={.={}, f:jobStatus={.={}, f:jobId={}, f:jobName={}, f:savepointInfo={.={}, f:lastPeriodicSavepointTimestamp={}, f:lastSavepoint={.={}, f:formatType={}, f:location={}, f:timeStamp={}, f:triggerType={}}, f:savepointHistory={}}, f:startTime={}, f:state={}, f:updateTime={}}, f:lifecycleState={}, f:reconciliationStatus={.={}, f:lastReconciledSpec={}, f:lastStableSpec={}, f:reconciliationTimestamp={}, f:state={}}}}), manager=fabric8-kubernetes-client, operation=Update, subresource=status, time=2023-09-18T21:59:34Z, additionalProperties={})], name=basic-session-job-only-example, namespace=default, ownerReferences=[], resourceVersion=561872, selfLink=null, uid=f3ee1b4e-3d82-4588-9040-3ac1c68aac3f, additionalProperties={}), spec=FlinkSessionJobSpec(super=AbstractFlinkSpec(job=JobSpec(jarURI=https://github.com/kristoffSC/FlinkSimpleStreamingJob/raw/jarTests/FlinkSimpleStreamingJob-1.0-SNAPSHOT.jar, parallelism=1, entryClass=null, args=[--restart, yes], state=RUNNING, savepointTriggerNonce=null, initialSavepointPath=null, upgradeMode=SAVEPOINT, allowNonRestoredState=null), restartNonce=null, flinkConfiguration=null), deploymentName=basic-session-deployment-only-example), status=FlinkSessionJobStatus(super=CommonStatus(jobStatus=JobStatus(jobName=FLink Toy Streaming job., jobId=f3ee1b4e3d8245880000000000000003, state=RUNNING, startTime=1695074236928, updateTime=1695074374179, savepointInfo=SavepointInfo(lastSavepoint=Savepoint(timeStamp=1695073569337, location=file:/opt/flink/jobs/savepoint-f3ee1b-1d4c88582b8c, triggerType=UPGRADE, formatType=UNKNOWN, triggerNonce=null), triggerId=null, triggerTimestamp=null, triggerType=null, formatType=null, savepointHistory=[Savepoint(timeStamp=1695073569337, location=file:/opt/flink/jobs/savepoint-f3ee1b-1d4c88582b8c, triggerType=UPGRADE, formatType=UNKNOWN, triggerNonce=null)], lastPeriodicSavepointTimestamp=0)), error=null, lifecycleState=STABLE, immediateReconciliationNeeded=false), reconciliationStatus=FlinkSessionJobReconciliationStatus(super=ReconciliationStatus(reconciliationTimestamp=1695074238730, lastReconciledSpec={"spec":{"job":{"jarURI":"https://github.com/kristoffSC/FlinkSimpleStreamingJob/raw/jarTests/FlinkSimpleStreamingJob-1.0-SNAPSHOT.jar","parallelism":1,"entryClass":null,"args":["--restart","yes"],"state":"running","savepointTriggerNonce":null,"initialSavepointPath":null,"upgradeMode":"savepoint","allowNonRestoredState":null},"restartNonce":null,"flinkConfiguration":null,"deploymentName":"basic-session-deployment-only-example"},"resource_metadata":{"apiVersion":"flink.apache.org/v1beta1","metadata":{"generation":3},"firstDeployment":false}}, lastStableSpec={"spec":{"job":{"jarURI":"https://github.com/kristoffSC/FlinkSimpleStreamingJob/raw/jarTests/FlinkSimpleStreamingJob-1.0-SNAPSHOT.jar","parallelism":1,"entryClass":null,"args":["--restart","yes"],"state":"running","savepointTriggerNonce":null,"initialSavepointPath":null,"upgradeMode":"savepoint","allowNonRestoredState":null},"restartNonce":null,"flinkConfiguration":null,"deploymentName":"basic-session-deployment-only-example"},"resource_metadata":{"apiVersion":"flink.apache.org/v1beta1","metadata":{"generation":3},"firstDeployment":false}}, state=DEPLOYED)))}
Cluster: basic-session-deployment-only-example
Job name: basic-session-job-only-example
Job state: RUNNING
Job upgrade mode: SAVEPOINT
Job Labels: {target.session=basic-session-deployment-only-example}
SavePoint Info: SavepointInfo(lastSavepoint=Savepoint(timeStamp=1695073569337, location=file:/opt/flink/jobs/savepoint-f3ee1b-1d4c88582b8c, triggerType=UPGRADE, formatType=UNKNOWN, triggerNonce=null), triggerId=null, triggerTimestamp=null, triggerType=null, formatType=null, savepointHistory=[Savepoint(timeStamp=1695073569337, location=file:/opt/flink/jobs/savepoint-f3ee1b-1d4c88582b8c, triggerType=UPGRADE, formatType=UNKNOWN, triggerNonce=null)], lastPeriodicSavepointTimestamp=0)
```

FlinkSessionJob (resumed from savepoint) data after updating job args and job labels:

